# API Integration Documentation

This document explains how PTV-LML integrates with external APIs to provide its functionality.

## PTV Timetable API

PTV-LML uses the Public Transport Victoria (PTV) Timetable API v3 to fetch public transport data.

### Authentication

The PTV API requires HMAC-SHA1 signature-based authentication:

1. Each request must include a developer ID (`devid`) as a query parameter
2. A signature is generated by:
   - Creating a request string (the API endpoint path + query parameters including the devid)
   - Generating an HMAC-SHA1 hash of this string using the API key
   - Converting the hash to uppercase hexadecimal
3. The signature is added as a query parameter to the request

This is implemented in the `generateSignature` function in `lib/ptv-api.ts`.

### Endpoints Used

PTV-LML uses the following PTV API endpoints:

- `/v3/route_types` - Get all route types (train, tram, bus, etc.)
- `/v3/routes` - Get all routes for a specific route type
- `/v3/directions/route/{route_id}` - Get directions for a specific route
- `/v3/stops/route/{route_id}/route_type/{route_type}` - Get stops for a specific route and route type
- `/v3/stops/{stop_id}/route_type/{route_type}` - Get details for a specific stop
- `/v3/departures/route_type/{route_type}/stop/{stop_id}` - Get departures from a specific stop

### Caching Strategy

To reduce API calls and improve performance, PTV-LML implements client-side caching:

1. When data is fetched from the API, it's stored in the browser's localStorage
2. Each cached item includes a timestamp
3. Before making an API call, the app checks if cached data exists and is still fresh
4. If the cache is stale (older than a defined threshold), the app refreshes the data in the background

## Live Music Locator API

PTV-LML integrates with the Live Music Locator API to fetch information about live music events.

### Endpoints Used

- `/gigs/query` - Get gigs based on location and date parameters

### Gig-Stop Integration

To show gigs near public transport stops:

1. When a user views stops for a route, the app loads stop information including coordinates
2. When a user checks for nearby gigs, the app:
   - Calls the Live Music Locator API to get today's gigs
   - Calculates the distance between each gig venue and the stop using the Haversine formula
   - Filters gigs to those within a specified radius (default: 500 meters)
   - Sorts gigs by distance from the stop

This integration allows users to discover live music events that are easily accessible via public transport.

## Error Handling

Both API integrations include robust error handling:

1. API-specific error classes (`PTVApiError` and `LMLApiError`) capture status codes and messages
2. Network errors are caught and presented to the user with friendly messages
3. Retry logic is implemented for transient failures
4. Fallback to cached data when API calls fail

## Environment Variables

The following environment variables are required for API integration:

- `NEXT_PUBLIC_PTV_DEV_ID` - PTV API developer ID (publicly visible in client-side code)
- `PTV_API_KEY` - PTV API key (server-side only, used for signature generation)

These should be set in a `.env.local` file for local development.
